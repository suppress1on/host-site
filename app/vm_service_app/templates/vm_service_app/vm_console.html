{# host-site/app/vm_service_app/templates/vm_service_app/vm_console.html #}
{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Консоль ВМ - Host Site</title>
    <link rel="stylesheet" href="{% static 'css/dark.css' %}">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: #1e1e1e; /* Темный фон */
            color: #c9d1d9; /* Светлый текст */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .console-header {
            background-color: #2a2a2a;
            padding: 15px 20px;
            border-bottom: 1px solid #30363d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .console-header h1 {
            margin: 0;
            color: #58a6ff; /* Цвет заголовка */
            font-size: 1.5em;
        }
        .back-button {
            background-color: #007bff;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
        }
        .back-button:hover {
            background-color: #0056b3;
        }
        .console-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #0d1117; /* Очень темный фон для консоли */
            border-radius: 0 0 8px 8px; /* Скругленные углы снизу */
            margin: 0 20px 20px 20px; /* Отступы по бокам и снизу */
            overflow: hidden; /* Скрываем все, что выходит за границы */
        }
        #console-output {
            flex-grow: 1;
            background-color: #0d1117;
            color: #39ff14; /* Ярко-зеленый текст для консоли */
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            white-space: pre-wrap; /* Сохраняет пробелы и переводы строк */
            overflow-y: auto; /* Прокрутка для длинного вывода */
            border: none;
            resize: none; /* Запрещаем изменение размера пользователем */
            outline: none; /* Убираем рамку при фокусе */
            height: 100%; /* Занимает всю доступную высоту */
        }
        #console-input {
            width: 100%;
            padding: 10px;
            background-color: #161b22; /* Темнее, чем фон консоли */
            border: none;
            border-top: 1px solid #30363d;
            color: #c9d1d9;
            font-family: 'Courier New', Courier, monospace;
            outline: none;
            box-sizing: border-box; /* Включаем padding и border в общую ширину */
        }
        /* Стили для сообщений Django */
        .messages {
            list-style: none;
            padding: 0;
            margin: 20px;
        }
        .status-message {
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    {# Отображение Django-сообщений (success, error, info) #}
    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li class="status-message {{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}

    <div class="console-header">
        <h1>Консоль ВМ: {{ vm_instance.name }}</h1>
        <a href="{% url 'main_app:home' %}" class="back-button">Вернуться на главную</a>
    </div>

    <div class="console-container">
        <textarea id="console-output" readonly></textarea>
        <input type="text" id="console-input" placeholder="Введите команду...">
    </div>

    {# Подключаем наш JavaScript файл в конце body для лучшей производительности #}
    <script src="{% static 'js/main.js' %}"></script>
    <script>
        const vmId = "{{ vm_instance.pk }}";
        const consoleOutput = document.getElementById('console-output');
        const consoleInput = document.getElementById('console-input');

        // Определяем протокол WebSocket (ws или wss) в зависимости от текущего протокола HTTP
        const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
        const socket = new WebSocket(
            wsProtocol + window.location.host + '/ws/vm/' + vmId + '/console/'
        );

        socket.onopen = function(e) {
            console.log("WebSocket connection established.");
            consoleOutput.value += "Соединение с консолью установлено.\n";
            consoleInput.focus(); // Устанавливаем фокус на поле ввода
        };

        socket.onmessage = function(e) {
            // Получаем данные из консоли ВМ и добавляем их в область вывода
            consoleOutput.value += e.data;
            // Прокручиваем вывод вниз
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };

        socket.onclose = function(e) {
            console.error('WebSocket connection closed unexpectedly. Code: ' + e.code + ', Reason: ' + e.reason);
            consoleOutput.value += "\nСоединение с консолью разорвано. Пожалуйста, обновите страницу, чтобы попробовать снова.\n";
            consoleInput.disabled = true; // Отключаем ввод
        };

        socket.onerror = function(e) {
            console.error('WebSocket error: ', e);
            consoleOutput.value += "\nОшибка WebSocket. Пожалуйста, проверьте подключение.\n";
            consoleInput.disabled = true; // Отключаем ввод
        };

        // Отправка ввода пользователя при нажатии Enter
        consoleInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const command = consoleInput.value + '\n'; // Добавляем перевод строки для отправки команды
                socket.send(command);
                consoleInput.value = ''; // Очищаем поле ввода
                e.preventDefault(); // Предотвращаем стандартное поведение Enter (например, добавление новой строки в input)
            }
        });

        // Дополнительная обработка для обеспечения фокусировки и прокрутки
        window.onload = function() {
            consoleInput.focus();
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };
    </script>
</body>
</html>